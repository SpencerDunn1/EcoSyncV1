<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Breaker Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }
    .breaker-section {
      background: #fff;
      padding: 20px;
      margin: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 800px;
    }
    h2 {
      margin-top: 0;
    }
    .controls button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .on { background-color: #28a745; color: white; }
    .off { background-color: #dc3545; color: white; }
  </style>
</head>
<body>
  <h1>Smart Breaker Control</h1>

  <!-- Breaker sections -->
  <div class="breaker-section" id="breaker-0">
    <h2>Breaker 1</h2>
    <div class="controls">
      <button class="on" onclick="toggleBreaker(0, true)">Turn ON</button>
      <button class="off" onclick="toggleBreaker(0, false)">Turn OFF</button>
    </div>
    <p><strong>Status:</strong> <span id="relay-state-0">Loading...</span></p>
    <p><strong>Power:</strong> <span id="power-0">-</span> W</p>
    <p><strong>Voltage:</strong> <span id="voltage-0">-</span> V</p>
    <p><strong>Current:</strong> <span id="current-0">-</span> A</p>
    <canvas id="powerChart-0" height="100"></canvas>
  </div>

  <div class="breaker-section" id="breaker-1">
    <h2>Breaker 2</h2>
    <div class="controls">
      <button class="on" onclick="toggleBreaker(1, true)">Turn ON</button>
      <button class="off" onclick="toggleBreaker(1, false)">Turn OFF</button>
    </div>
    <p><strong>Status:</strong> <span id="relay-state-1">Loading...</span></p>
    <p><strong>Power:</strong> <span id="power-1">-</span> W</p>
    <p><strong>Voltage:</strong> <span id="voltage-1">-</span> V</p>
    <p><strong>Current:</strong> <span id="current-1">-</span> A</p>
    <canvas id="powerChart-1" height="100"></canvas>
  </div>

  <script>
    const API_KEY = "supersecurekey";
    const BACKEND_URL = "https://your-backend.onrender.com";

    const charts = {};

    function setupChart(breakerId) {
      const ctx = document.getElementById(`powerChart-${breakerId}`).getContext('2d');
      charts[breakerId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Power (W)',
            data: [],
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'Time' }},
            y: { title: { display: true, text: 'Power (W)' }, beginAtZero: true }
          }
        }
      });
    }

    function toggleBreaker(id, turnOn) {
      fetch(`${BACKEND_URL}/breaker/${id}/${turnOn ? 'on' : 'off'}`, {
        method: "POST",
        headers: { "x-api-key": API_KEY }
      })
      .then(res => res.json())
      .then(data => console.log("Breaker toggled:", data.status))
      .catch(err => console.error("Error:", err));
    }

    function updateStatus(id) {
      fetch(`${BACKEND_URL}/breaker/${id}/status`, {
        headers: { "x-api-key": API_KEY }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById(`relay-state-${id}`).innerText = data.output ? "ON" : "OFF";
        document.getElementById(`power-${id}`).innerText = data.apower?.toFixed(1) || "-";
        document.getElementById(`voltage-${id}`).innerText = data.voltage?.toFixed(1) || "-";
        document.getElementById(`current-${id}`).innerText = data.current?.toFixed(2) || "-";

        const chart = charts[id];
        const now = new Date().toLocaleTimeString();
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(data.apower || 0);

        if (chart.data.labels.length > 288) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }
        chart.update();
      })
      .catch(err => console.error("Status fetch error:", err));
    }

    function startPolling() {
      [0, 1].forEach(id => {
        setupChart(id);
        updateStatus(id);
        setInterval(() => updateStatus(id), 300000); // every 5 mins
      });
    }

    startPolling();
  </script>
</body>
</html>
